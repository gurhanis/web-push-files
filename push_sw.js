"use strict";importScripts("https://cdnjs.cloudflare.com/ajax/libs/localforage/1.5.0/localforage.nopromises.min.js"),self.addEventListener("push",function(e){if(e.data){var t=JSON.parse(e.data.text());t.shop_id&&fetch("https://api.rees46.com/web_push_subscriptions/received",{mode:"cors",method:"post",credentials:"include",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"url="+encodeURIComponent(t.url)+"&shop_id="+encodeURIComponent(t.shop_id)}),e.waitUntil(self.registration.showNotification(t.title,{body:t.body,icon:t.icon,tag:"rees46-push-notification",actions:t.actions||[],data:{shop_id:t.shop_id,url:t.url,action_urls:t.action_urls||[]}}))}}),self.addEventListener("notificationclick",function(e){if(e.notification.close(),Notification.prototype.hasOwnProperty("data")){var t=e.notification.data.url,o=e.notification.data.action_urls||[];"b0"===e.action&&"undefined"!=typeof o[0]?t=o[0]:"b1"===e.action&&"undefined"!=typeof o[1]&&(t=o[1]),e.notification.data.shop_id&&fetch("https://api.rees46.com/web_push_subscriptions/clicked",{mode:"cors",method:"post",credentials:"include",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"url="+encodeURIComponent(e.notification.data.url)+"&shop_id="+encodeURIComponent(e.notification.data.shop_id)}),e.waitUntil(clients.openWindow(t))}}),self.addEventListener("message",function(e){e.data&&(e.data.shop_id&&localforage.setItem("rees46_shop_id",e.data.shop_id),e.data.ssid&&localforage.setItem("rees46_session_id",e.data.ssid))}),self.addEventListener("pushsubscriptionchange",function(e){e.waitUntil(registration.pushManager.subscribe({userVisibleOnly:!0}).then(function(e){localforage.getItem("rees46_shop_id").then(function(t){localforage.getItem("rees46_session_id").then(function(o){fetch("https://api.rees46.com/web_push_subscriptions",{mode:"cors",method:"post",credentials:"include",headers:{"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:"shop_id="+encodeURIComponent(t)+"&ssid="+encodeURIComponent(o)+"&token="+encodeURIComponent(JSON.stringify(e.toJSON()))})})})}))});
